# 深度对话功能说明

## 🎯 新增功能：对话深度增强

### 1. **对话历史记录**
- 系统会自动记录最近5轮对话历史
- LLM在识别意图时会考虑对话上下文
- 支持基于上下文的意图识别

### 2. **追问机制**（深度对话）
每个主要场景的回复后都会自动提供追问选项，支持：
- **订单追问**：物流、配送、送达时间等
- **退款追问**：退款进度、到账时间、退款方式等
- **商品追问**：规格、评价、使用说明、保修等
- **账户追问**：会员权益、积分、等级、专属优惠等
- **优惠追问**：更多优惠、限时活动、会员折扣等

### 3. **话题发散**（深度对话）
支持从当前话题自然发散到相关话题：
- 订单 → 物流跟踪、订单修改、发票申请等
- 退款 → 换货服务、商品评价、售后服务等
- 商品 → 优惠活动、新品上架、限时特价等
- 账户 → 会员升级、积分兑换、优惠券领取等
- 优惠 → 会员折扣、限时活动、满减优惠等

### 4. **通用追问和话题发散**
- **通用追问**：支持"继续"、"详细说明"、"多说点"等自然追问
- **话题发散**：支持"还有什么"、"其他服务"等话题扩展

## 💬 深度对话示例

### 示例1：订单查询的深度对话
```
用户: 查询订单
机器人: 请输入您的订单号...
用户: 12345
机器人: 您的订单12345状态是：已发货
        您还想了解订单的其他信息吗？比如物流详情、预计送达时间、配送方式等？

用户: 物流
机器人: 关于物流信息：您的订单预计3-5个工作日送达...
        除了订单查询，您可能还想了解：物流跟踪、订单修改、发票申请、订单评价等服务

用户: 继续
机器人: 好的，让我继续为您介绍。您还想了解订单的其他信息吗？比如物流详情...
```

### 示例2：退款申请的深度对话
```
用户: 退款
机器人: 请选择退款原因...
用户: 质量问题
机器人: 请输入订单号...
用户: 12345
机器人: 退款申请已提交！申请号：REF4512
        关于退款，您还有其他问题吗？比如退款到账时间、退款方式、退款进度查询等？

用户: 退款进度
机器人: 关于退款进度：退款通常在3-5个工作日内到账...
        除了退款，您可能还想了解：换货服务、商品评价、售后服务、质量问题处理等

用户: 还有什么
机器人: 当然有！除了退款，您可能还想了解：换货服务、商品评价、售后服务...
```

### 示例3：商品推荐的深度对话
```
用户: 推荐商品
机器人: 请告诉我您想买什么类型的商品...
用户: 手机
机器人: 推荐：最新款智能手机，性能强劲，拍照清晰，价格美丽！📱
        您还想了解这个商品的更多信息吗？比如详细规格、用户评价、使用说明、保修政策等？

用户: 规格
机器人: 关于商品详情：我们提供详细的商品规格、用户评价、使用说明和保修政策...
        除了商品推荐，您可能还想了解：优惠活动、新品上架、限时特价、品牌故事等

用户: 详细点
机器人: 好的，让我继续为您介绍。您还想了解这个商品的更多信息吗？比如详细规格...
```

## 🔧 技术实现

### 1. 对话历史管理
- `conversation_history`: 存储最近对话记录
- `last_intent`: 记录上一次的意图
- `last_context`: 记录上一次的上下文变量

### 2. 上下文感知的意图识别
- LLM接收对话历史和上下文信息
- 能够理解追问和话题发散
- 支持多轮对话的连贯性

### 3. 新增函数
- `get_follow_up_question(topic)`: 生成追问问题
- `get_related_topic(topic)`: 获取相关话题

## 📝 使用建议

### 测试深度对话
1. **先问一个主要问题**：如"查询订单"、"退款"、"推荐商品"
2. **根据回复中的追问提示继续**：如"物流"、"退款进度"、"规格"
3. **使用通用追问**：如"继续"、"详细说明"、"多说点"
4. **尝试话题发散**：如"还有什么"、"其他服务"

### 对话流程示例
```
订单查询 → 物流详情 → 继续追问 → 话题发散 → 其他服务
```

## ✨ 特色亮点

1. **智能上下文理解**：系统能理解对话上下文，支持自然追问
2. **话题自然发散**：可以从一个话题自然过渡到相关话题
3. **多轮对话连贯性**：保持对话的连贯性和逻辑性
4. **深度信息挖掘**：支持就一个问题深入追问，获取更多信息

享受深度对话体验！🎉

